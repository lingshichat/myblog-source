<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>泠诗的存图站</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.min.js"></script>
    <link rel="stylesheet" href="gallery.css">
</head>

<body>
    <script src="../js/bg-loader-bitiful.js"></script>

    <div id="app" v-cloak class="app-container">
        <!-- 主界面 -->
        <template>
            <!-- 顶部导航 -->
            <nav class="glass-nav">
                <div class="nav-left">
                    <span class="logo-text"><i class="fa-solid fa-images"></i> 泠诗的存图站</span>
                </div>
                <div class="nav-right">
                    <span class="image-count"><i class="fa-regular fa-image"></i> {{ images.length }} 张</span>
                    <button class="nav-btn" @click="loadImages" :disabled="loading" title="刷新">
                        <i class="fa-solid fa-rotate-right" :class="{'fa-spin': loading}"></i>
                    </button>
                    <button class="nav-btn" v-if="!sessionToken" @click="openAuthModal('login')" title="登录">
                        <i class="fa-solid fa-right-to-bracket"></i>
                    </button>
                    <button class="nav-btn" v-if="!sessionToken" @click="openAuthModal('register')" title="注册">
                        <i class="fa-solid fa-user-plus"></i>
                    </button>
                    <button class="nav-btn" v-if="sessionRole === 'admin'" @click="openAdminPanel" title="管理员控制中心">
                        <i class="fa-solid fa-shield-halved"></i>
                    </button>
                    <button class="nav-btn logout-btn" v-if="sessionToken" @click="logout" title="退出登录">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </nav>

            <!-- 分类菜单栏 -->
            <div class="category-bar">
                <button v-for="cat in categories" v-if="cat.key !== 'mine' || sessionToken" :key="cat.key"
                    class="category-btn" :class="{ 'active': currentCategory === cat.key }"
                    @click="selectCategory(cat.key)">
                    <i :class="cat.icon"></i>
                    <span>{{ cat.name }}</span>
                    <span class="category-count" v-if="categoryCounts[cat.key]">{{ categoryCounts[cat.key] }}</span>
                </button>
            </div>

            <!-- 主内容区 -->
            <main class="gallery-main">
                <div class="drop-zone" :class="{ 'active': isDragging }" @dragenter.prevent="isDragging = true"
                    @dragover.prevent="isDragging = true" @dragleave.prevent="isDragging = false"
                    @drop.prevent="handleDrop">
                    <div class="drop-hint" v-if="isDragging">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                        <p>释放以上传</p>
                    </div>
                </div>

                <!-- 图片网格 -->
                <div class="masonry-grid" v-if="images.length > 0">
                    <div class="masonry-item" v-for="image in images" :key="image.key">
                        <a :href="image.url" data-fancybox="gallery" :data-caption="image.title || image.name">
                            <img :src="lazyPlaceholder" :data-src="image.thumbnailUrl" :alt="image.title || image.name"
                                class="lazy-image" @load="onLazyImageLoad">
                        </a>
                        <div class="image-overlay">
                            <span class="image-title" v-if="image.title">{{ image.title }}</span>
                            <span class="image-name" v-else>{{ image.name }}</span>
                            <div class="image-tags" v-if="image.tags && image.tags.length">
                                <span class="tag" v-for="tag in image.tags.slice(0, 3)" :key="tag">{{ tag }}</span>
                                <span class="tag more" v-if="image.tags.length > 3">+{{ image.tags.length - 3 }}</span>
                            </div>
                            <div class="image-actions">
                                <button class="action-btn" @click="copyMarkdown(image)" title="复制 Markdown"><i
                                        class="fa-solid fa-code"></i></button>
                                <button class="action-btn" @click="copyUrl(image)" title="复制链接"><i
                                        class="fa-regular fa-copy"></i></button>
                                <template v-if="sessionRole === 'admin'">
                                    <button class="action-btn edit-btn" @click="openEditModal(image)" title="编辑"><i
                                            class="fa-solid fa-pen"></i></button>
                                    <button class="action-btn delete-btn" @click="confirmDelete(image)" title="删除"><i
                                            class="fa-solid fa-trash"></i></button>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <div ref="loadMoreSentinel" class="loading-state"
                    v-if="images.length > 0 && (hasMoreCurrentCategory || loadingMore)">
                    <i class="fa-solid" :class="loadingMore ? 'fa-circle-notch fa-spin' : 'fa-ellipsis'"></i>
                    <p>{{ loadingMore ? '正在加载更多...' : '下滑以加载更多' }}</p>
                </div>

                <div class="empty-state" v-else-if="images.length === 0 && !loading">
                    <i class="fa-regular fa-images"></i>
                    <h3>暂无图片</h3>
                    <p>{{ currentCategory === 'all' ? '拖拽图片到此处或点击右下角按钮上传' : (currentCategory === 'mine' ? '你还没有上传图片' :
                        '该分类下暂无图片') }}</p>
                </div>

                <div class="loading-state" v-if="loading && images.length === 0">
                    <i class="fa-solid fa-circle-notch fa-spin"></i>
                    <p>正在加载图片...</p>
                </div>
            </main>

            <!-- FAB 上传按钮 -->
            <button class="fab-upload" v-if="sessionToken && (sessionRole === 'user' || sessionRole === 'admin')"
                @click="showUploadModal = true" title="上传图片"><i class="fa-solid fa-plus"></i></button>
            <input type="file" ref="fileInput" @change="handleFileSelect" accept="image/*" multiple hidden>

            <!-- 上传弹窗 -->
            <transition name="fade">
                <div class="modal-overlay" v-if="showUploadModal" @click.self="showUploadModal = false">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fa-solid fa-cloud-arrow-up"></i> 上传图片</h3>
                            <button class="close-btn" @click="showUploadModal = false"><i
                                    class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="file-drop-area" :class="{ 'has-file': uploadFiles.length > 0 }"
                                @click="$refs.fileInput.click()" @dragover.prevent @drop.prevent="handleModalDrop">
                                <template v-if="uploadFiles.length === 0">
                                    <i class="fa-solid fa-cloud-arrow-up"></i>
                                    <p>点击或拖拽图片到此处</p>
                                    <span class="file-hint">支持 JPG、PNG、GIF、WEBP</span>
                                </template>
                                <template v-else>
                                    <div class="file-preview-list">
                                        <div class="file-preview-item" v-for="(file, idx) in uploadFiles" :key="idx">
                                            <img :src="file.preview" v-if="file.preview">
                                            <span class="file-name">{{ file.name }}</span>
                                            <button class="remove-file" @click.stop="removeFile(idx)"><i
                                                    class="fa-solid fa-xmark"></i></button>
                                        </div>
                                    </div>
                                    <p class="add-more" @click.stop="$refs.fileInput.click()"><i
                                            class="fa-solid fa-plus"></i> 添加更多</p>
                                </template>
                            </div>
                            <div class="form-group">
                                <label><i class="fa-solid fa-heading"></i> 图片标题（可选）</label>
                                <input type="text" v-model="uploadTitle" placeholder="给图片起个名字..." class="form-input">
                            </div>
                            <div class="form-group">
                                <label><i class="fa-solid fa-tags"></i> 标签（可选）</label>
                                <div class="tags-input-area">
                                    <div class="tags-list">
                                        <span class="tag-item" v-for="(tag, idx) in uploadTags" :key="idx">{{ tag
                                            }}<button @click="removeTag(idx)"><i
                                                    class="fa-solid fa-xmark"></i></button></span>
                                    </div>
                                    <input type="text" v-model="newTag" @keyup.enter="addTag" placeholder="输入标签后按回车..."
                                        class="form-input tag-input">
                                </div>
                            </div>
                            <div class="form-group">
                                <label><i class="fa-solid fa-folder"></i> 选择分类</label>
                                <div class="category-select">
                                    <button v-for="cat in uploadCategories" :key="cat.key" class="category-option"
                                        :class="{ 'selected': uploadCategory === cat.key }"
                                        @click="uploadCategory = cat.key">
                                        <i :class="cat.icon"></i> {{ cat.name }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" @click="showUploadModal = false">取消</button>
                            <button class="btn-primary" @click="startUpload"
                                :disabled="uploadFiles.length === 0 || uploading">
                                <i class="fa-solid" :class="uploading ? 'fa-circle-notch fa-spin' : 'fa-upload'"></i> {{
                                uploading ? '上传中...' : '开始上传' }}
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- 编辑弹窗 -->
            <transition name="fade">
                <div class="modal-overlay" v-if="showEditModal" @click.self="showEditModal = false">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fa-solid fa-pen"></i> 编辑图片</h3>
                            <button class="close-btn" @click="showEditModal = false"><i
                                    class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="edit-preview" v-if="editingImage"><img :src="editingImage.thumbnailUrl"></div>
                            <div class="form-group">
                                <label><i class="fa-solid fa-heading"></i> 图片标题</label>
                                <input type="text" v-model="editTitle" placeholder="给图片起个名字..." class="form-input">
                            </div>
                            <div class="form-group">
                                <label><i class="fa-solid fa-tags"></i> 标签</label>
                                <div class="tags-input-area">
                                    <div class="tags-list">
                                        <span class="tag-item" v-for="(tag, idx) in editTags" :key="idx">{{ tag
                                            }}<button @click="removeEditTag(idx)"><i
                                                    class="fa-solid fa-xmark"></i></button></span>
                                    </div>
                                    <input type="text" v-model="newEditTag" @keyup.enter="addEditTag"
                                        placeholder="输入标签后按回车..." class="form-input tag-input">
                                </div>
                            </div>
                            <div class="form-group">
                                <label><i class="fa-solid fa-folder"></i> 移动到分类</label>
                                <div class="category-select">
                                    <button v-for="cat in uploadCategories" :key="cat.key" class="category-option"
                                        :class="{ 'selected': editCategory === cat.key }"
                                        @click="editCategory = cat.key">
                                        <i :class="cat.icon"></i> {{ cat.name }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" @click="showEditModal = false">取消</button>
                            <button class="btn-primary" @click="saveEdit" :disabled="savingEdit">
                                <i class="fa-solid" :class="savingEdit ? 'fa-circle-notch fa-spin' : 'fa-save'"></i> {{
                                savingEdit ? '保存中...' : '保存更改' }}
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- 登录/注册弹窗 -->
            <transition name="fade">
                <div class="modal-overlay" v-if="showAuthModal" @click.self="showAuthModal = false">
                    <div class="modal-content" style="max-width: 420px;">
                        <div class="modal-header">
                            <h3>
                                <i class="fa-solid"
                                    :class="authMode === 'register' ? 'fa-user-plus' : 'fa-right-to-bracket'"></i>
                                {{ authMode === 'register' ? '注册账号' : '账号登录' }}
                            </h3>
                            <button class="close-btn" @click="showAuthModal = false"><i
                                    class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label><i class="fa-solid fa-envelope"></i> 邮箱</label>
                                <input type="email" v-model="authEmail" @keyup.enter="submitAuth"
                                    placeholder="name@example.com" class="form-input" autofocus>
                            </div>
                            <div class="form-group">
                                <label><i class="fa-solid fa-key"></i> 密码</label>
                                <input type="password" v-model="authPassword" @keyup.enter="submitAuth"
                                    placeholder="请输入密码" class="form-input">
                            </div>
                            <div class="form-group" v-if="authMode === 'register'">
                                <label><i class="fa-solid fa-ticket"></i> 邀请码</label>
                                <input type="text" v-model="inviteCode" @keyup.enter="submitAuth" placeholder="请输入邀请码"
                                    class="form-input" style="text-transform: uppercase;">
                            </div>
                            <transition name="fade">
                                <p class="error-text" v-if="authError">{{ authError }}</p>
                            </transition>
                            <p class="admin-hint" style="margin-top: 8px;">
                                {{ authMode === 'register' ? '已有账号？' : '没有账号？' }}
                                <a href="javascript:void(0)"
                                    @click="authMode = authMode === 'register' ? 'login' : 'register'">
                                    {{ authMode === 'register' ? '去登录' : '去注册' }}
                                </a>
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" @click="showAuthModal = false">取消</button>
                            <button class="btn-primary" @click="submitAuth"
                                :disabled="authSubmitting || !authEmail || !authPassword || (authMode === 'register' && !inviteCode)">
                                <i class="fa-solid"
                                    :class="authSubmitting ? 'fa-circle-notch fa-spin' : (authMode === 'register' ? 'fa-user-plus' : 'fa-right-to-bracket')"></i>
                                {{ authSubmitting ? '提交中...' : (authMode === 'register' ? '注册并登录' : '登录') }}
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- 管理员控制中心 -->
            <transition name="fade">
                <div class="modal-overlay" v-if="showAdminPanel" @click.self="showAdminPanel = false">
                    <div class="modal-content admin-panel">
                        <div class="modal-header">
                            <h3><i class="fa-solid fa-shield-halved"></i> 管理员控制中心</h3>
                            <button class="close-btn" @click="showAdminPanel = false"><i
                                    class="fa-solid fa-xmark"></i></button>
                        </div>
                        <!-- Tab 切换 -->
                        <div class="admin-tabs">
                            <button :class="{ active: adminPanelTab === 'users' }" @click="adminPanelTab = 'users'">
                                <i class="fa-solid fa-users"></i> 用户管理
                            </button>
                            <button :class="{ active: adminPanelTab === 'invites' }" @click="adminPanelTab = 'invites'">
                                <i class="fa-solid fa-ticket"></i> 邀请码
                            </button>
                        </div>
                        <div class="modal-body admin-panel-body">
                            <!-- 加载中 -->
                            <div v-if="adminLoading" style="text-align:center; padding:24px;">
                                <i class="fa-solid fa-circle-notch fa-spin" style="font-size:1.5rem;"></i>
                            </div>
                            <!-- 用户管理 -->
                            <template v-if="!adminLoading && adminPanelTab === 'users'">
                                <div class="admin-table-wrap">
                                    <table class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>邮箱</th>
                                                <th>角色</th>
                                                <th>状态</th>
                                                <th>注册时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="u in adminUsers" :key="u.id">
                                                <td>{{ u.email }}</td>
                                                <td><span class="role-badge" :class="u.role">{{ u.role === 'admin' ?
                                                        '管理员' : '用户' }}</span></td>
                                                <td><span class="status-dot" :class="u.status"></span>{{ u.status ===
                                                    'active' ? '活跃' : '禁用' }}</td>
                                                <td>{{ u.createdAt ? u.createdAt.slice(0,10) : '-' }}</td>
                                                <td class="action-cell">
                                                    <button class="mini-btn" @click="adminToggleRole(u)" title="切换角色"><i
                                                            class="fa-solid fa-repeat"></i></button>
                                                    <button class="mini-btn danger" @click="adminToggleStatus(u)"
                                                        :title="u.status === 'active' ? '禁用' : '启用'"><i class="fa-solid"
                                                            :class="u.status === 'active' ? 'fa-ban' : 'fa-check'"></i></button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </template>
                            <!-- 邀请码管理 -->
                            <template v-if="!adminLoading && adminPanelTab === 'invites'">
                                <div class="invite-toolbar">
                                    <div class="invite-create">
                                        <label>使用次数</label>
                                        <input type="number" v-model.number="newInviteMaxUses" min="1" max="100"
                                            class="form-input" style="width:80px;">
                                        <button class="btn-primary" @click="adminCreateInvite"><i
                                                class="fa-solid fa-plus"></i> 生成邀请码</button>
                                    </div>
                                </div>
                                <div class="admin-table-wrap">
                                    <table class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>邀请码</th>
                                                <th>创建者</th>
                                                <th>使用</th>
                                                <th>状态</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="inv in adminInvites" :key="inv.code">
                                                <td><code class="invite-code">{{ inv.code }}</code></td>
                                                <td>{{ inv.creatorEmail || inv.creatorId }}</td>
                                                <td>{{ inv.usedCount }}/{{ inv.maxUses === -1 ? '∞' : inv.maxUses }}
                                                </td>
                                                <td><span class="status-dot" :class="inv.status"></span>{{ inv.status
                                                    === 'active' ? '有效' : '已禁用' }}</td>
                                                <td class="action-cell">
                                                    <button class="mini-btn" @click="copyInviteCode(inv.code)"
                                                        title="复制"><i class="fa-solid fa-copy"></i></button>
                                                    <button class="mini-btn"
                                                        :class="inv.status === 'active' ? 'danger' : 'success'"
                                                        @click="adminToggleInvite(inv)"
                                                        :title="inv.status === 'active' ? '禁用' : '启用'"><i
                                                            class="fa-solid"
                                                            :class="inv.status === 'active' ? 'fa-ban' : 'fa-check'"></i></button>
                                                </td>
                                            </tr>
                                            <tr v-if="adminInvites.length === 0">
                                                <td colspan="5" style="text-align:center; color: var(--text-muted);">
                                                    暂无邀请码</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- 上传进度 -->
            <transition name="fade">
                <div class="upload-overlay" v-if="uploading">
                    <div class="upload-modal">
                        <div class="upload-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
                        <h3>正在上传</h3>
                        <p class="upload-filename">{{ uploadFileName }}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" :style="{ width: uploadProgress + '%' }"></div>
                        </div>
                        <span class="progress-text">{{ uploadProgress }}%</span>
                    </div>
                </div>
            </transition>

            <!-- Toast -->
            <transition name="slide-down">
                <div class="toast" v-if="toast.show" :class="toast.type">
                    <i class="fa-solid"
                        :class="toast.type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'"></i> {{
                    toast.message }}
                </div>
            </transition>
        </template>
    </div>
    <script src="gallery.js"></script>
</body>

</html>