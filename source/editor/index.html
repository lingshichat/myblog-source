<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∫ëÁ´ØÁÅµÊÑüÁ©∫Èó¥ | Editor</title>

    <!-- Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <!-- <script type="module" src="https://cdn.skypack.dev/@octokit/rest"></script> Removed: Imported in app.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>

    <!-- APlayer & MetingJS (Audio Support) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
    <script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Flatpickr (Glass Datepicker Support) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!-- Custom Style -->
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app" v-cloak>
        <!-- üîê ÁôªÂΩïÁïåÈù¢ (ÈáçÊûÑÁâà) -->
        <div v-if="!isLoggedIn" class="login-container">
            <div class="login-card">
                <!-- ÊºÇÊµÅÁì∂/ÁæΩÊØõÁ¨îÂõæÊ†á -->
                <div class="login-icon-wrapper">
                    <i class="fa-solid fa-feather-pointed login-icon"></i>
                    <div class="icon-glow"></div>
                </div>

                <h2 class="login-title">ÁÅµÊÑü ¬∑ ÂΩíÊ°£</h2>

                <div class="login-input-area">
                    <input type="password" v-model="password" @keyup.enter="login" placeholder="ËæìÂÖ•ÂØÜÈí•ÔºåÂºÄÂêØÊó∂Á©∫..." autofocus>
                    <button class="login-btn" @click="login" :disabled="loading">
                        <i class="fa-solid" :class="loading ? 'fa-circle-notch fa-spin' : 'fa-arrow-right'"></i>
                    </button>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="remember" v-model="rememberMe">
                    <label for="remember">ËÆ∞‰ΩèÂØÜÁ†Å</label>
                </div>

                <!-- Ê∏©ÊüîÁöÑÈîôËØØÊèêÁ§∫ -->
                <transition name="fade">
                    <div v-if="errorMsg" class="error-toast">
                        <i class="fa-regular fa-face-frown-open"></i> {{ errorMsg }}
                    </div>
                </transition>
            </div>
        </div>

        <!-- üìù ÁºñËæëÂô®ÁïåÈù¢ -->
        <div v-else class="editor-container">
            <!-- È°∂ÈÉ®ÂØºËà™ -->
            <nav class="glass-nav">
                <div class="nav-left">
                    <button class="nav-btn toggle-sidebar" @click="toggleSidebar">
                        <i class="fa-solid fa-bars-staggered"></i>
                    </button>
                    <span class="logo-text">EDITOR</span>
                </div>
                <div class="nav-right">
                    <!-- ‰øùÂ≠òÁä∂ÊÄÅÊåáÁ§∫ -->
                    <span class="save-status" v-if="saving || saveStatus">
                        <i class="fa-solid" :class="saving ? 'fa-spinner fa-spin' : 'fa-check'"></i>
                        {{ saving ? 'ÂêåÊ≠•‰∏≠...' : saveStatus }}
                    </span>

                    <!-- ÁôªÂá∫ÊåâÈíÆ (Êõ¥ÈöêËîΩ) -->
                    <button class="nav-btn logout-btn" @click="logout" title="Êñ≠ÂºÄËøûÊé•">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </div>
            </nav>

            <div class="main-content">
                <!-- Â∑¶‰æßÊñáÁ´†ÂàóË°® -->
                <aside class="sidebar" :class="{ 'open': sidebarOpen }">
                    <div class="sidebar-header">
                        <h3>{{ viewMode === 'trash' ? 'RECYCLE BIN' : 'ALL POSTS' }}</h3>
                        <div class="header-actions">
                            <button class="refresh-btn" @click="viewMode === 'trash' ? fetchTrashPosts() : fetchPosts()"
                                title="Âà∑Êñ∞"><i class="fa-solid fa-rotate-right"></i></button>
                        </div>
                    </div>

                    <!-- Êñ∞Âª∫ÊåâÈíÆÁßªÂà∞ÂàóË°®‰∏äÊñπ -->
                    <!-- Êñ∞Âª∫ÊåâÈíÆÁßªÂà∞ÂàóË°®‰∏äÊñπ -->
                    <div class="sidebar-actions">
                        <button v-if="viewMode === 'posts'" class="new-post-btn" @click="newPost">
                            <i class="fa-solid fa-plus"></i> Êñ∞Âª∫ÁØáÁ´†
                        </button>
                        <button v-else class="new-post-btn" @click="toggleViewMode('posts')">
                            <i class="fa-solid fa-arrow-left"></i> ËøîÂõûÂàóË°®
                        </button>

                        <button v-if="viewMode === 'posts'" class="trash-toggle-btn" @click="toggleViewMode('trash')"
                            title="ÂõûÊî∂Á´ô">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>

                    <ul class="post-list">
                        <li v-for="post in (viewMode === 'trash' ? trashPosts : posts)" :key="post.sha"
                            @click="loadPost(post)"
                            :class="{ active: currentPost && (currentPost.sha === post.sha || (currentPost.path === post.path && currentPost.name === post.name)) }">
                            <span class="post-title">{{ post.name.replace('.md', '') }}</span>
                            <!-- <span class="post-date">{{ formatDate(post.date) }}</span> -->
                        </li>
                        <li v-if="(viewMode === 'trash' ? trashPosts : posts).length === 0" class="empty-state">
                            {{ viewMode === 'trash' ? 'ÂõûÊî∂Á´ôÁ©∫Á©∫Â¶Ç‰πü' : 'ÊöÇÊó†ÁØáÁ´†...' }}
                        </li>
                    </ul>
                </aside>

                <!-- ÈÅÆÁΩ©Â±Ç (Mobile) -->
                <div class="sidebar-overlay" @click="sidebarOpen = false"></div>

                <!-- Ê†∏ÂøÉÂ∑•‰ΩúÂå∫ -->
                <main class="editor-area">
                    <!-- 0. Á©∫Áä∂ÊÄÅ (Welcome) -->
                    <div v-show="!editMode && !currentPost" class="welcome-mode">
                        <div class="welcome-content">
                            <div class="welcome-logo">
                                <i class="fa-solid fa-feather-pointed"></i>
                            </div>
                            <h2>ÂáÜÂ§áÂ•ΩËÆ∞ÂΩïÂΩì‰∏ãÁöÑÁÅµÊÑü‰∫ÜÂêóÔºü</h2>
                            <p>ÈÄâÊã©Â∑¶‰æßÁØáÁ´†ËøõË°åÂõûÈ°æÔºåÊàñËÄÖÂºÄÂêØ‰∏ÄÊÆµÊñ∞ÁöÑÊóÖÁ®ã„ÄÇ</p>
                            <button class="primary-btn" @click="newPost">
                                <i class="fa-solid fa-plus"></i> ÂºÄÂßãÂàõ‰Ωú
                            </button>
                        </div>
                    </div>

                    <!-- 1. È¢ÑËßàÊ®°Âºè‰∏ãÁöÑÈòÖËØªÂô® -->
                    <div v-show="!editMode && currentPost" class="reader-mode">
                        <div class="reader-header">
                            <h1>{{ postTitle || 'Êú™ÂëΩÂêçÁØáÁ´†' }}</h1>
                            <div class="reader-actions">
                                <template v-if="viewMode === 'posts'">
                                    <button class="edit-btn" @click="enableEditMode">
                                        <i class="fa-solid fa-pen-nib"></i> ‰øÆÊîπ
                                    </button>
                                    <button class="delete-btn" @click="moveToTrash">
                                        <i class="fa-solid fa-trash-can"></i> Âà†Èô§
                                    </button>
                                </template>
                                <template v-else>
                                    <button class="restore-btn" @click="restorePost">
                                        <i class="fa-solid fa-trash-arrow-up"></i> ËøòÂéü
                                    </button>
                                    <button class="destroy-btn" @click="permanentDelete">
                                        <i class="fa-solid fa-ban"></i> ÂΩªÂ∫ïÂà†Èô§
                                    </button>
                                </template>
                            </div>
                        </div>
                        <div class="reader-meta">
                            <span class="meta-capsule time-capsule">
                                <i class="fa-regular fa-clock"></i> {{ postDate || 'ÂàöÂàö' }}
                            </span>

                            <span v-for="(cat, index) in postCategories" :key="'cat-'+index"
                                class="meta-capsule category-capsule">
                                <i class="fa-regular fa-folder"></i> {{ cat }}
                            </span>

                            <span v-for="(tag, index) in postTags" :key="'tag-'+index" class="meta-capsule tag-capsule">
                                <i class="fa-solid fa-tags"></i> {{ tag }}
                            </span>
                        </div>
                        <div class="reader-content markdown-body" id="preview-content">
                            <!-- Ê∏≤ÊüìÂêéÁöÑ HTML Â∞ÜÊ≥®ÂÖ•ËøôÈáå -->
                        </div>
                    </div>

                    <!-- 2. ÁºñËæëÊ®°Âºè -->
                    <div v-show="editMode" class="writer-mode" :class="{ 'zen-mode': fullscreenMode }">
                        <div class="metadata-form">
                            <div class="meta-header">
                                <input type="text" v-model="postTitle" placeholder="Âú®Ê≠§ËæìÂÖ•Ê†áÈ¢ò..." class="title-input">
                                <div class="meta-actions">
                                    <button class="cancel-btn" @click="cancelEdit" title="ÂèñÊ∂à‰øÆÊîπ">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                    <button class="publish-btn" @click="savePost" :disabled="saving">
                                        <i class="fa-solid fa-paper-plane"></i> ÂèëÂ∏É
                                    </button>
                                </div>
                            </div>
                            <div class="meta-tags-container">
                                <!-- Êó•ÊúüÈÄâÊã© (Flatpickr Glass) -->
                                <div class="meta-group" style="flex: 0 0 220px;">
                                    <div class="input-icon"><i class="fa-regular fa-clock"></i></div>
                                    <input type="text" id="date-picker" v-model="postDate" class="glass-date-input"
                                        placeholder="ÈÄâÊã©ÂèëÂ∏ÉÊó∂Èó¥...">
                                </div>

                                <!-- Ê†áÁ≠æ (ËÉ∂Âõä) -->
                                <div class="meta-group flex-group">
                                    <div class="input-icon"><i class="fa-solid fa-tags"></i></div>
                                    <div class="capsule-container">
                                        <div v-for="(tag, index) in postTags" :key="'t'+index" class="capsule-tag">
                                            {{ tag }}
                                            <i class="fa-solid fa-xmark" @click="removeTag(index)"></i>
                                        </div>
                                        <input type="text" v-model="tagInput" @keydown.enter="addTag"
                                            @keydown.delete="!tagInput && removeTag(postTags.length - 1)"
                                            placeholder="ËæìÂÖ•Ê†áÁ≠æ..." class="capsule-input">
                                    </div>
                                </div>

                                <!-- ÂàÜÁ±ª (ËÉ∂Âõä) -->
                                <div class="meta-group flex-group">
                                    <div class="input-icon"><i class="fa-regular fa-folder"></i></div>
                                    <div class="capsule-container">
                                        <div v-for="(cat, index) in postCategories" :key="'c'+index"
                                            class="capsule-tag category-tag">
                                            {{ cat }}
                                            <i class="fa-solid fa-xmark" @click="removeCategory(index)"></i>
                                        </div>
                                        <input type="text" v-model="catInput" @keydown.enter="addCategory"
                                            @keydown.delete="!catInput && removeCategory(postCategories.length - 1)"
                                            placeholder="ËæìÂÖ•ÂàÜÁ±ª..." class="capsule-input">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="editor-wrapper" :class="{ 'split-active': splitMode }">
                            <textarea id="markdown-editor"></textarea>
                            <!-- Ëá™ÂÆö‰πâÂèåÊ†èÈ¢ÑËßàÂå∫ -->
                            <div v-show="splitMode" class="custom-split-preview markdown-body"
                                v-html="compiledMarkdown"></div>
                        </div>
                    </div>

                    <!-- Updated Time Tag (Reader Mode Only) -->
                    <div class="last-updated-tag" v-if="!editMode && currentPost && postUpdated">
                        <i class="fa-regular fa-clock"></i> Êú¨ÊñáÊõ¥Êñ∞‰∫é: {{ postUpdated }}
                    </div>
                </main>
            </div>
        </div>
        <!-- ÊãüÁâ©ÂåñÂÖ®Â±Ä Modal -->
        <div id="modal-container" :class="{ visible: modal.show }">
            <div class="glass-modal">
                <div class="modal-header">
                    <h3>
                        <i class="fa-solid fa-spinner fa-spin" v-if="modal.type === 'loading'"
                            style="color: var(--primary-color);"></i>
                        <i class="fa-solid fa-triangle-exclamation" v-else-if="modal.type === 'confirm'"
                            style="color: #ffd700;"></i>
                        {{ modal.title }}
                    </h3>
                </div>
                <div class="modal-body">
                    <p>{{ modal.message }}</p>
                </div>
                <!-- Âè™ÊúâÈùû loading Áä∂ÊÄÅÊâçÊòæÁ§∫Êìç‰ΩúÊåâÈíÆ -->
                <div class="modal-actions" v-if="modal.type !== 'loading'">
                    <button v-if="modal.type === 'confirm'" class="modal-cancel-btn modal-btn"
                        @click="closeModal(false)">ÂèñÊ∂à</button>
                    <button class="modal-confirm-btn modal-btn" @click="closeModal(true)">Á°ÆÂÆö</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="auth.js"></script>
    <script type="module" src="app.js"></script>
</body>

</html>